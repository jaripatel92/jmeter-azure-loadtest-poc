name: Azure Load Test - Working POC

on:
  workflow_dispatch:

jobs:
  run-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Execute Azure Load Test via REST
        shell: bash
        env:
          ENDPOINT: "${{ secrets.AZURE_SUBSCRIPTION_ID }}.eastus.cnt-prod.loadtesting.azure.com"
          TOKEN: "${{ secrets.AZURE_BEARER_TOKEN }}"
          TEST_ID: "${{ secrets.AZURE_TEST_ID }}"
        run: |
          set -euo pipefail
          echo "Uploading JMX to Azure Load Testing..."

          curl -sS -o upload_resp.json -w "%{http_code}" \
            -X PUT "https://${ENDPOINT}/tests/${TEST_ID}/files/basic_smoke_test.jmx?api-version=2022-11-01" \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Content-Type: application/octet-stream" \
            --data-binary "@jmeter/basic_smoke_test.jmx"

          echo "Triggering new run..."
          RUN_ID="run-${GITHUB_RUN_NUMBER}"
          curl -sS -o run_resp.json -w "%{http_code}" \
            -X PATCH "https://${ENDPOINT}/test-runs/${RUN_ID}?api-version=2022-11-01" \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Content-Type: application/merge-patch+json" \
            -d "{\"testId\":\"${TEST_ID}\",\"displayName\":\"${RUN_ID}\"}"

          echo "Run triggered successfully! See Azure portal for Test ID=${TEST_ID}, Run ID=${RUN_ID}."
